{"version":3,"file":"theme-downloader.js","sourceRoot":"","sources":["../../../src/cli/utilities/theme-downloader.ts"],"names":[],"mappings":"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","sourcesContent":["import {applyIgnoreFilters} from './asset-ignore.js'\nimport {removeThemeFile, writeThemeFile} from './theme-fs.js'\n\nimport {AdminSession} from '@shopify/cli-kit/node/session'\nimport {fetchThemeAsset} from '@shopify/cli-kit/node/themes/api'\nimport {ThemeFileSystem, Theme, Checksum} from '@shopify/cli-kit/node/themes/types'\nimport {renderTasks} from '@shopify/cli-kit/node/ui'\n\ninterface DownloadOptions {\n  nodelete: boolean\n  only?: string[]\n  ignore?: string[]\n}\n\nexport async function downloadTheme(\n  theme: Theme,\n  session: AdminSession,\n  remoteChecksums: Checksum[],\n  themeFileSystem: ThemeFileSystem,\n  options: DownloadOptions,\n) {\n  const deleteTasks = buildDeleteTasks(remoteChecksums, themeFileSystem, options)\n  const downloadTasks = await buildDownloadTasks(remoteChecksums, theme, themeFileSystem, session, options)\n\n  const tasks = [...deleteTasks, ...downloadTasks]\n\n  if (tasks.length > 0) {\n    await renderTasks(tasks)\n  }\n}\n\nfunction buildDeleteTasks(remoteChecksums: Checksum[], themeFileSystem: ThemeFileSystem, options: DownloadOptions) {\n  if (options.nodelete) return []\n\n  const remoteKeys = new Set(remoteChecksums.map((checksum) => checksum.key))\n\n  const localKeys = Array.from(themeFileSystem.files.keys())\n  const localFilesToBeDeleted = localKeys.filter((key) => !remoteKeys.has(key))\n\n  return localFilesToBeDeleted.map((key) => {\n    return {\n      title: `Cleaning your local directory (removing ${key})`,\n      task: async () => removeThemeFile(themeFileSystem.root, key),\n    }\n  })\n}\n\nasync function buildDownloadTasks(\n  remoteChecksums: Checksum[],\n  theme: Theme,\n  themeFileSystem: ThemeFileSystem,\n  session: AdminSession,\n  options: DownloadOptions,\n) {\n  const checksums = await applyIgnoreFilters(remoteChecksums, themeFileSystem, options)\n\n  return checksums\n    .map((checksum) => {\n      const remoteChecksumValue = checksum.checksum\n      const localAsset = themeFileSystem.files.get(checksum.key)\n\n      if (localAsset?.checksum === remoteChecksumValue) {\n        return\n      }\n\n      const progress = progressPct(remoteChecksums, checksum)\n      const title = `Pulling theme \"${theme.name}\" (#${theme.id}) from ${session.storeFqdn} [${progress}%]`\n\n      return {\n        title,\n        task: async () => downloadFile(theme, themeFileSystem, checksum, session),\n      }\n    })\n    .filter(notNull)\n}\n\nasync function downloadFile(theme: Theme, {root}: ThemeFileSystem, checksum: Checksum, session: AdminSession) {\n  const themeAsset = await fetchThemeAsset(theme.id, checksum.key, session)\n\n  if (!themeAsset) return\n\n  await writeThemeFile(root, themeAsset)\n}\n\nfunction progressPct(themeChecksums: Checksum[], checksum: Checksum): number {\n  const current = themeChecksums.indexOf(checksum) + 1\n  const total = themeChecksums.length\n\n  return Math.round((current / total) * 100)\n}\n\nfunction notNull<T>(value: T | null | undefined): value is T {\n  return value !== null && value !== undefined\n}\n"]}