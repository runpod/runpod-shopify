{"version":3,"file":"push.js","sourceRoot":"","sources":["../../../src/cli/services/push.ts"],"names":[],"mappings":"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","sourcesContent":["import {mountThemeFileSystem} from '../utilities/theme-fs.js'\nimport {uploadTheme} from '../utilities/theme-uploader.js'\nimport {rejectGeneratedStaticAssets} from '../utilities/asset-checksum.js'\nimport {themeComponent} from '../utilities/theme-ui.js'\nimport {AdminSession} from '@shopify/cli-kit/node/session'\nimport {fetchChecksums, publishTheme} from '@shopify/cli-kit/node/themes/api'\nimport {Result, Theme} from '@shopify/cli-kit/node/themes/types'\nimport {outputInfo} from '@shopify/cli-kit/node/output'\nimport {renderSuccess, renderWarning} from '@shopify/cli-kit/node/ui'\nimport {themeEditorUrl, themePreviewUrl} from '@shopify/cli-kit/node/themes/urls'\n\ninterface PushOptions {\n  path: string\n  nodelete?: boolean\n  json?: boolean\n  force?: boolean\n  publish?: boolean\n  ignore?: string[]\n  only?: string[]\n}\n\ninterface JsonOutput {\n  theme: {\n    id: number\n    name: string\n    role: string\n    shop: string\n    editor_url: string\n    preview_url: string\n    warning?: string\n  }\n}\n\nexport async function push(theme: Theme, session: AdminSession, options: PushOptions) {\n  const remoteChecksums = await fetchChecksums(theme.id, session)\n  const themeFileSystem = await mountThemeFileSystem(options.path)\n  const themeChecksums = rejectGeneratedStaticAssets(remoteChecksums)\n\n  const results = await uploadTheme(theme, session, themeChecksums, themeFileSystem, options)\n\n  if (options.publish) {\n    await publishTheme(theme.id, session)\n  }\n\n  await handlePushOutput(results, theme, session, options)\n}\n\nfunction hasUploadErrors(results: Map<string, Result>): boolean {\n  for (const [_key, result] of results.entries()) {\n    if (!result.success) {\n      return true\n    }\n  }\n  return false\n}\n\nasync function handlePushOutput(\n  results: Map<string, Result>,\n  theme: Theme,\n  session: AdminSession,\n  options: PushOptions,\n) {\n  const hasErrors = hasUploadErrors(results)\n\n  if (options.json) {\n    handleJsonOutput(theme, hasErrors, session)\n  } else if (options.publish) {\n    handlePublishOutput(hasErrors, session)\n  } else {\n    handleOutput(theme, hasErrors, session)\n  }\n}\n\nfunction handleJsonOutput(theme: Theme, hasErrors: boolean, session: AdminSession) {\n  const output: JsonOutput = {\n    theme: {\n      id: theme.id,\n      name: theme.name,\n      role: theme.role,\n      shop: session.storeFqdn,\n      editor_url: themeEditorUrl(theme, session),\n      preview_url: themePreviewUrl(theme, session),\n    },\n  }\n\n  if (hasErrors) {\n    const message = `The theme ${themeComponent(theme).join(' ')} was pushed with errors`\n    output.theme.warning = message\n  }\n  outputInfo(JSON.stringify(output))\n}\n\nfunction handlePublishOutput(hasErrors: boolean, session: AdminSession) {\n  if (hasErrors) {\n    renderWarning({body: `Your theme was published with errors and is now live at https://${session.storeFqdn}`})\n  } else {\n    renderSuccess({body: `Your theme is now live at https://${session.storeFqdn}`})\n  }\n}\n\nfunction handleOutput(theme: Theme, hasErrors: boolean, session: AdminSession) {\n  const nextSteps = [\n    [\n      {\n        link: {\n          label: 'View your theme',\n          url: themePreviewUrl(theme, session),\n        },\n      },\n    ],\n    [\n      {\n        link: {\n          label: 'Customize your theme at the theme editor',\n          url: themeEditorUrl(theme, session),\n        },\n      },\n    ],\n  ]\n\n  if (hasErrors) {\n    renderWarning({\n      body: ['The theme', ...themeComponent(theme), 'was pushed with errors'],\n      nextSteps,\n    })\n  } else {\n    renderSuccess({\n      body: ['The theme', ...themeComponent(theme), 'was pushed successfully.'],\n      nextSteps,\n    })\n  }\n}\n"]}